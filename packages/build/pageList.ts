import * as console from 'console';
import * as fs from 'fs';
import * as path from 'path';
import * as process from 'process';
import {JSON} from '../es/global';
import {rootDirectoryPath} from '../fs/constants';
import {runScript} from '../node/runScript';
import {getPageList} from '../page/getPageList';

runScript(async () => {
    if (process.env.CI) {
        console.info('BuildPageList: skipped');
        return;
    }
    const {pageListByPublishedAt, toListByUpdatedAt} = await getPageList();
    const code = `
// This file was generated by \`npm run build:pageList\`
/* eslint-disable */
export interface PageData {
    pathname: string,
    title: string,
    filePath: string,
    publishedAt: string,
    updatedAt: string,
    commitCount: number,
    archiveOf?: string,
    description?: string,
}
export const pageListByPublishedAt: Array<PageData> = ${JSON.stringify(pageListByPublishedAt, null, 4)};
export const pageListByUpdatedAt: Array<PageData> = ${JSON.stringify(toListByUpdatedAt)}.map((index) => pageListByPublishedAt[index]);
`.trimStart();
    const dest = path.join(rootDirectoryPath, 'packages/site/pageList.ts');
    await fs.promises.writeFile(dest, code);
    console.info(`BuildPageList: ${dest}`);
});
